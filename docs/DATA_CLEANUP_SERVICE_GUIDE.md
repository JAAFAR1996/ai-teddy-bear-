# ๐๏ธ Data Cleanup Service Guide
## ุฎุฏูุฉ ุชูุธูู ุงูุจูุงูุงุช ุงูุฃูุชููุงุชููู - ุฏููู ุดุงูู

### ๐ ูุธุฑุฉ ุนุงูุฉ

ุฎุฏูุฉ ุชูุธูู ุงูุจูุงูุงุช ุงูุฃูุชููุงุชููู ูู ูุธุงู ูุชูุฏู ูุตูู ูุฅุฏุงุฑุฉ ุฏูุฑุฉ ุญูุงุฉ ุงูุจูุงูุงุช ูู ูุธุงู AI Teddy Bear. ุชุถูู ุงูุฎุฏูุฉ ุงูุงูุชุซุงู ูุณูุงุณุงุช ุงูุฎุตูุตูุฉ ูุน ุงูุญูุงุธ ุนูู ุงูุฃุฏุงุก ุงูุฃูุซู ููุงุนุฏุฉ ุงูุจูุงูุงุช.

### ๐ฏ ุงูููุฒุงุช ุงูุฑุฆูุณูุฉ

- **ุญุฐู ุฏูุฑู ุฃูุชููุงุชููู**: ุญุฐู ุงูุจูุงูุงุช ุงููุฏููุฉ ุญุณุจ ุงูุณูุงุณุงุช ุงููุญุฏุฏุฉ
- **ุฅุดุนุงุฑุงุช ุงููุงูุฏูู**: ุชูุจููุงุช ูุจู ุญุฐู ุงูุจูุงูุงุช ุจู 7 ุฃูุงู
- **ูุณุฎ ุงุญุชูุงุทูุฉ**: ุฅูุดุงุก ูุณุฎ ุงุญุชูุงุทูุฉ ูุจู ุงูุญุฐู
- **ุฌุฏููุฉ ูุชูุฏูุฉ**: ุงุณุชุฎุฏุงู APScheduler ููุชูููุฐ ุงูุฏูุฑู
- **ูุฑุงูุจุฉ ุดุงููุฉ**: ุชุณุฌูู ููุตู ูุฅุญุตุงุฆูุงุช ุงูุนูููุงุช
- **API ุฅุฏุงุฑูุฉ**: endpoints ููุชุญูู ุงููุฏูู ูุงููุฑุงูุจุฉ

### ๐๏ธ ูุนูุงุฑูุฉ ุงููุธุงู

```
Data Cleanup System
โโโ DataCleanupService (ุงูุฎุฏูุฉ ุงูุฃุณุงุณูุฉ)
โ   โโโ CleanupPolicy (ุณูุงุณุงุช ุงูุญุฐู)
โ   โโโ CleanupStats (ุฅุญุตุงุฆูุงุช ุงูุนูููุงุช)
โ   โโโ Backup Manager (ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ)
โโโ SchedulerService (ุฎุฏูุฉ ุงูุฌุฏููุฉ)
โ   โโโ APScheduler Integration
โ   โโโ Job Management
โ   โโโ Status Monitoring
โโโ FastAPI Integration (ุชูุงูู ูุน ุงูุชุทุจูู ุงูุฑุฆูุณู)
    โโโ Admin Endpoints
    โโโ Startup/Shutdown Hooks
    โโโ Health Monitoring
```

### ๐ ูููู ุงููููุงุช

```
src/application/services/
โโโ data_cleanup_service.py      # ุงูุฎุฏูุฉ ุงูุฃุณุงุณูุฉ
โโโ scheduler_service.py         # ุฎุฏูุฉ ุงูุฌุฏููุฉ

src/main.py                      # ุชูุงูู ูุน ุงูุชุทุจูู ุงูุฑุฆูุณู
test_data_cleanup_service.py     # ุงุฎุชุจุงุฑุงุช ุดุงููุฉ
RUN_DATA_CLEANUP_TEST.bat        # ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช
```

### โ๏ธ ุงูุฅุนุฏุงุฏ ูุงูุชูููู

#### 1. ุณูุงุณุงุช ุงูุชูุธูู ุงูุงูุชุฑุงุถูุฉ

```python
CleanupPolicy(
    interactions_retention_days=30,     # ุญูุธ ุงูุชูุงุนูุงุช ูู 30 ููู
    emotions_retention_days=30,         # ุญูุธ ุงููุดุงุนุฑ ูู 30 ููู
    health_records_retention_days=90,   # ุญูุธ ุงูุณุฌูุงุช ุงูุตุญูุฉ ูู 90 ููู
    summaries_retention_days=365,       # ุญูุธ ุงูููุฎุตุงุช ูุณูุฉ ูุงุญุฏุฉ
    notification_days_before=7,         # ุฅุฑุณุงู ุฅุดุนุงุฑ ูุจู 7 ุฃูุงู
    backup_before_delete=True           # ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุจู ุงูุญุฐู
)
```

#### 2. ุฌุฏููุฉ ุงูููุงู

- **ุชูุธูู ูููู**: ููุชุตู ุงูููู (00:00 UTC)
- **ูุฑุงูุจุฉ ุณุงุนูุฉ**: ูู ุณุงุนุฉ ุนูุฏ ุงูุฏูููุฉ 0
- **ุชุญุณูู ุฃุณุจูุนู**: ุงูุฃุญุฏ ูู ุงูุณุงุนุฉ 2:00 ุตุจุงุญุงู
- **ุชูุฑูุฑ ูููู**: 6:00 ุตุจุงุญุงู

#### 3. ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู

```json
{
  "EMAIL_CONFIG": {
    "smtp_server": "smtp.gmail.com",
    "smtp_port": 587,
    "from_email": "noreply@aiteddybear.com",
    "password": "your_app_password"
  }
}
```

### ๐ ุงูุงุณุชุฎุฏุงู

#### 1. ุงูุชุดุบูู ุงูุชููุงุฆู

ุชุจุฏุฃ ุงูุฎุฏูุฉ ุชููุงุฆูุงู ูุน ุชุทุจูู FastAPI:

```python
# ูู src/main.py
from src.application.services.scheduler_service import start_scheduler
start_scheduler()
```

#### 2. ุงูุชุญูู ุงููุฏูู

```python
from src.application.services.data_cleanup_service import run_daily_cleanup, preview_cleanup

# ูุนุงููุฉ ุงูุจูุงูุงุช ุงููุฑุดุญุฉ ููุญุฐู
preview = await preview_cleanup()
print(preview)

# ุชุดุบูู ุงูุชูุธูู ููุฑุงู
stats = await run_daily_cleanup()
print(f"ุชู ุญุฐู {stats.sessions_deleted} ุฌูุณุฉ")
```

#### 3. ุฅุฏุงุฑุฉ ุงูุฌุฏููุฉ

```python
from src.application.services.scheduler_service import get_scheduler_status, trigger_cleanup_now

# ุงูุชุญูู ูู ุญุงูุฉ ุงููุฌุฏูู
status = get_scheduler_status()
print(f"ุงููุฌุฏูู ูุนูู: {status['scheduler_running']}")

# ุชุดุบูู ุงูุชูุธูู ููุฑุงู
await trigger_cleanup_now()
```

### ๐ API Endpoints

#### ุฅุฏุงุฑุฉ ุงููุฌุฏูู

```http
GET /admin/scheduler/status
```
**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "scheduler_running": true,
  "total_jobs": 4,
  "jobs": [
    {
      "id": "daily_data_cleanup",
      "name": "Daily Data Cleanup",
      "next_run_time": "2025-01-20T00:00:00+00:00",
      "trigger": "cron[hour=0,minute=0]"
    }
  ]
}
```

#### ุชุดุบูู ุงูุชูุธูู ูุฏููุงู

```http
POST /admin/scheduler/cleanup/trigger
```
**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "message": "Data cleanup triggered successfully",
  "stats": {
    "sessions_deleted": 15,
    "emotions_deleted": 142,
    "summaries_deleted": 0,
    "children_notified": 3,
    "backups_created": 1,
    "errors_count": 0,
    "execution_time_seconds": 2.45
  }
}
```

#### ูุนุงููุฉ ุงูุจูุงูุงุช

```http
GET /admin/data/preview
```
**ุงูุงุณุชุฌุงุจุฉ:**
```json
{
  "policy": {
    "interactions_retention_days": 30,
    "emotions_retention_days": 30,
    "summaries_retention_days": 365
  },
  "cutoff_dates": {
    "sessions": "2024-12-21T00:00:00",
    "emotions": "2024-12-21T00:00:00",
    "summaries": "2024-01-20T00:00:00"
  },
  "items_to_delete": {
    "sessions": 25,
    "emotions": 230,
    "summaries": 0,
    "total": 255
  }
}
```

### ๐ ุงููุฑุงูุจุฉ ูุงูุชุณุฌูู

#### 1. Structured Logging

```python
import structlog
logger = structlog.get_logger(__name__)

# ุชุณุฌูู ุจูุงูุงุช ูููููุฉ
logger.info("Data cleanup completed",
           sessions_deleted=10,
           execution_time=1.23,
           backup_created=True)
```

#### 2. ููุงููุณ Prometheus

- `teddy_cleanup_sessions_deleted_total`
- `teddy_cleanup_execution_duration_seconds`
- `teddy_cleanup_errors_total`
- `teddy_cleanup_backups_created_total`

#### 3. ุชูุจููุงุช ุงูุตุญุฉ

```python
# ุชุญูู ูู ุตุญุฉ ุงููุธุงู
if total_items_pending > 10000:
    logger.warning("Large amount of data pending cleanup",
                  total_items=total_items_pending)
```

### ๐๏ธ ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ

#### 1. ููุงู ุงูุชุฎุฒูู

```
data/backups/
โโโ cleanup_backup_20250120_000000.json
โโโ cleanup_backup_20250121_000000.json
โโโ cleanup_backup_20250122_000000.json
```

#### 2. ูููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ

```json
{
  "backup_date": "2025-01-20T00:00:00",
  "policy": {
    "interactions_retention_days": 30
  },
  "sessions": [
    {
      "id": 1,
      "udid": "TEDDY_ABC123",
      "child_name": "ุฃุญูุฏ",
      "child_age": 5,
      "timestamp": "2024-12-15T10:30:00",
      "emotions": [
        {
          "name": "Joy",
          "score": 0.85,
          "confidence": 0.92
        }
      ]
    }
  ]
}
```

### ๐งช ุงูุงุฎุชุจุงุฑ

#### ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช

```bash
# Windows
RUN_DATA_CLEANUP_TEST.bat

# Linux/Mac
python test_data_cleanup_service.py
```

#### ุงูุงุฎุชุจุงุฑุงุช ุงููุดูููุฉ

1. **ุงุณุชูุฑุงุฏ ุงูุฎุฏูุงุช**: ุงูุชุญูู ูู ุชููุฑ ุฌููุน ุงูุชุจุนูุงุช
2. **ุฅุนุฏุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ุงุฎุชุจุงุฑ ุงูุงุชุตุงู ูุงูููุงุฐุฌ
3. **ุฎุฏูุฉ ุงูุชูุธูู**: ุงุฎุชุจุงุฑ ุงูุนูููุงุช ุงูุฃุณุงุณูุฉ
4. **ุฎุฏูุฉ ุงูุฌุฏููุฉ**: ุงุฎุชุจุงุฑ APScheduler ูุงูููุงู
5. **ุชูุงูู ุงูุชุทุจูู**: ุงูุชุญูู ูู ุงูุชูุงูู ูุน main.py

### ๐ง ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

#### ูุดุงูู ุดุงุฆุนุฉ

1. **ูุดู ุจุฏุก ุงููุฌุฏูู**
   ```python
   # ุญู: ุงูุชุญูู ูู ุงูุชุจุนูุงุช
   pip install apscheduler==3.10.4
   ```

2. **ูุดููุฉ ูู ุงุณุชูุฑุงุฏ ูุงุนุฏุฉ ุงูุจูุงูุงุช**
   ```python
   # ุญู: ุงูุชุญูู ูู ูุณุงุฑ database.py
   from database import db_manager
   ```

3. **ูุดู ุฅุฑุณุงู ุงูุฅุดุนุงุฑุงุช**
   ```python
   # ุญู: ุชุญุฏูุซ ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ูู config.json
   ```

#### ุชุณุฌูู ุงูุฃุฎุทุงุก

```python
logger.error("Data cleanup failed",
           error=str(e),
           session_id=session_id,
           exc_info=True)
```

### ๐ ุงูุฃุฏุงุก ูุงูุชุญุณูู

#### ุชูุตูุงุช ุงูุฃุฏุงุก

1. **ุฌุฏููุฉ ุฐููุฉ**: ุชุดุบูู ุงูุชูุธูู ูู ุฃููุงุช ููุฎูุถุฉ ุงูุงุณุชุฎุฏุงู
2. **ุชุญุฏูุฏ ุญุฌู ุงูุฏูุนุฉ**: ุชุฌูุจ ุญุฐู ูููุงุช ูุจูุฑุฉ ูุฑุฉ ูุงุญุฏุฉ
3. **ููุฑุณุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช**: ููุฑุณุฉ ุฃุนูุฏุฉ timestamp
4. **ูุฑุงูุจุฉ ุงูุฐุงูุฑุฉ**: ุชุฌูุจ ุชุญููู ุฌููุน ุงูุจูุงูุงุช ูู ุงูุฐุงูุฑุฉ

#### ุฅุญุตุงุฆูุงุช ุงูุฃุฏุงุก

- **ูุชูุณุท ููุช ุงูุชูููุฐ**: 2-5 ุซูุงูู
- **ูุนุฏู ุงูุญุฐู**: ~1000 ุณุฌู/ุซุงููุฉ
- **ุงุณุชุฎุฏุงู ุงูุฐุงูุฑุฉ**: <100MB ููุนูููุงุช ุงูุนุงุฏูุฉ

### ๐ ุงูุฃูุงู ูุงูุฎุตูุตูุฉ

#### ุญูุงูุฉ ุงูุจูุงูุงุช

1. **ุชุดููุฑ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ**
2. **ุตูุงุญูุงุช ูุญุฏูุฏุฉ ููุญุฐู**
3. **ุชุณุฌูู ุดุงูู ููุนูููุงุช**
4. **ุฅุดุนุงุฑุงุช ุงููุงูุฏูู ุงูุฅูุฒุงููุฉ**

#### ุงูุงูุชุซุงู

- **GDPR**: ุญู ุงููุณูุงู
- **COPPA**: ุญูุงูุฉ ุฎุตูุตูุฉ ุงูุฃุทูุงู
- **ูุญูู**: ููุงููู ุญูุงูุฉ ุงูุจูุงูุงุช ุงููุญููุฉ

### ๐ ุงูุชุทููุฑ ุงููุณุชูุจูู

#### ููุฒุงุช ูุฎุทุทุฉ

1. **ุชุตุฏูุฑ ุงูุจูุงูุงุช**: ุชุตุฏูุฑ ุชููุงุฆู ูุจู ุงูุญุฐู
2. **ุณูุงุณุงุช ูุฎุตุตุฉ**: ุณูุงุณุงุช ูุฎุชููุฉ ููู ุทูู
3. **ุชุญููู ุงูุจูุงูุงุช**: ุชุญููู ุฃููุงุท ุงูุงุณุชุฎุฏุงู ูุจู ุงูุญุฐู
4. **ูุงุฌูุฉ ูุฑุฆูุฉ**: dashboard ููุฅุฏุงุฑุฉ

#### ุงูุชุญุณููุงุช

1. **ุฃุฏุงุก ุฃูุถู**: ุงุณุชุฎุฏุงู background tasks
2. **ูุฑููุฉ ุฃูุจุฑ**: ุณูุงุณุงุช ูุงุจูุฉ ููุชุฎุตูุต
3. **ููุซูููุฉ ุนุงููุฉ**: retry logic ูุชูุฏู
4. **ูุฑุงูุจุฉ ุดุงููุฉ**: metrics ุฃูุซุฑ ุชูุตููุงู

### ๐ ุงูุฏุนู

ูููุณุงุนุฏุฉ ุฃู ุงูุงุณุชูุณุงุฑุงุช:
- **ุงูุจุฑูุฏ ุงูุฅููุชุฑููู**: support@aiteddybear.com
- **ุงูุชูุซูู**: ุฑุงุฌุน ูุฐุง ุงูุฏููู
- **ุงูุงุฎุชุจุงุฑุงุช**: ุดุบู `RUN_DATA_CLEANUP_TEST.bat`

---

**ยฉ 2025 AI Teddy Bear Project - ุฎุฏูุฉ ุชูุธูู ุงูุจูุงูุงุช ุงูุฃูุชููุงุชููู** 