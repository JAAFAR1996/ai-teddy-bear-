apiVersion: v1
kind: ConfigMap
metadata:
  name: emergency-monitoring-config
  namespace: teddy-security
  labels:
    app: emergency-monitoring
    component: security
    environment: production
    version: v2025.1
  annotations:
    security.teddy.ai/level: "critical"
    monitoring.teddy.ai/emergency: "true"
data:
  prometheus.yml: |
    global:
      scrape_interval: 5s          # Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…ÙƒØ«ÙØ© ÙƒÙ„ 5 Ø«ÙˆØ§Ù†
      evaluation_interval: 5s     # ØªÙ‚ÙŠÙŠÙ… ÙÙˆØ±ÙŠ Ù„Ù„Ù‚ÙˆØ§Ø¹Ø¯
      scrape_timeout: 10s
      external_labels:
        monitor: 'teddy-emergency-security'
        cluster: 'production'
        datacenter: 'main'
        security_level: 'critical'
    
    # Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
    rule_files:
      - '/etc/prometheus/rules/security_critical.yml'
      - '/etc/prometheus/rules/api_security.yml'
      - '/etc/prometheus/rules/data_breach.yml'
      - '/etc/prometheus/rules/ddos_protection.yml'
      - '/etc/prometheus/rules/authentication.yml'
    
    # ØªÙƒÙˆÙŠÙ† Alertmanager Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
    alerting:
      alertmanagers:
        - static_configs:
          - targets: ['alertmanager-emergency:9093']
          scheme: https
          tls_config:
            ca_file: '/etc/ssl/certs/ca.pem'
            cert_file: '/etc/ssl/certs/client.pem'
            key_file: '/etc/ssl/private/client-key.pem'
          bearer_token_file: '/var/run/secrets/alertmanager/token'
    
    # ØªÙƒÙˆÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø£Ù…Ù†ÙŠØ© Ø§Ù„Ù…ÙƒØ«ÙØ©
    scrape_configs:
      # Ù…Ø±Ø§Ù‚Ø¨Ø© API Ø§Ù„Ø£Ù…Ù†ÙŠØ© - Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ù„ÙŠØ©
      - job_name: 'api-security-critical'
        metrics_path: '/security/metrics'
        scrape_interval: 3s
        scrape_timeout: 10s
        static_configs:
          - targets: ['api-gateway:8000', 'api-auth:8001', 'api-main:8002']
        relabel_configs:
          - source_labels: [__address__]
            target_label: __param_target
          - source_labels: [__param_target]
            target_label: instance
          - target_label: __address__
            replacement: 'api-security-exporter:9115'
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'teddy_security_.*'
            action: keep
        basic_auth:
          username: 'security_monitor'
          password_file: '/var/run/secrets/monitoring/password'
      
      # Ù…Ø±Ø§Ù‚Ø¨Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡Ø©
      - job_name: 'database-security'
        metrics_path: '/db/security-metrics'
        scrape_interval: 5s
        static_configs:
          - targets: ['postgres-security:9187', 'redis-security:9121']
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'pg_stat_activity_suspicious|redis_blocked_clients'
            action: keep
      
      # Ù…Ø±Ø§Ù‚Ø¨Ø© WAF ÙˆØ¬Ø¯Ø§Ø± Ø§Ù„Ø­Ù…Ø§ÙŠØ©
      - job_name: 'waf-security'
        metrics_path: '/waf/metrics'
        scrape_interval: 2s  # Ù…Ø±Ø§Ù‚Ø¨Ø© ÙØ§Ø¦Ù‚Ø© Ø§Ù„Ø³Ø±Ø¹Ø© Ù„Ù„Ù‡Ø¬Ù…Ø§Øª
        static_configs:
          - targets: ['nginx-waf:9113', 'cloudflare-exporter:9199']
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'nginx_waf_.*|cloudflare_security_.*'
            action: keep
      
      # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø´Ø¨ÙƒØ© ÙˆØ§Ù„ØªØ±Ø§ÙÙŠÙƒ Ø§Ù„Ù…Ø´Ø¨ÙˆÙ‡
      - job_name: 'network-security'
        metrics_path: '/network/security'
        scrape_interval: 3s
        static_configs:
          - targets: ['network-monitor:9100', 'snort-exporter:9166']
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'network_intrusion_.*|packet_suspicious_.*'
            action: keep
      
      # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ø­Ø§ÙˆÙŠØ§Øª Ù„Ù„Ø§Ø®ØªØ±Ø§Ù‚
      - job_name: 'system-security'
        metrics_path: '/metrics'
        scrape_interval: 5s
        static_configs:
          - targets: ['node-security:9100', 'container-security:8080']
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'node_security_.*|container_rootkit_.*'
            action: keep
      
      # Ù…Ø±Ø§Ù‚Ø¨Ø© ØªØ·Ø¨ÙŠÙ‚ Teddy Bear Ù„Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø£Ù…Ù†ÙŠ
      - job_name: 'teddy-app-security'
        metrics_path: '/app/security-metrics'
        scrape_interval: 2s
        static_configs:
          - targets: ['teddy-main:8000', 'teddy-ai:8001', 'teddy-audio:8002']
        scrape_configs:
          - source_labels: [__meta_kubernetes_service_name]
            target_label: service
          - source_labels: [__meta_kubernetes_pod_name]
            target_label: pod
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'teddy_security_violations|teddy_api_key_usage|teddy_child_data_access'
            action: keep
      
      # Ù…Ø±Ø§Ù‚Ø¨Ø© Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø³Ø­Ø§Ø¨Ø© (AWS/Azure/GCP)
      - job_name: 'cloud-security'
        metrics_path: '/cloud/security'
        scrape_interval: 10s
        static_configs:
          - targets: ['aws-security:9100', 'azure-security:9101']
        oauth2:
          client_id: 'teddy-security-monitor'
          client_secret_file: '/var/run/secrets/cloud/client-secret'
          token_url: 'https://security.teddycloud.ai/oauth/token'
      
      # Prometheus self-monitoring Ù„Ù„Ø£Ù…Ø§Ù†
      - job_name: 'prometheus-security'
        static_configs:
          - targets: ['localhost:9090']
        metric_relabel_configs:
          - source_labels: [__name__]
            regex: 'prometheus_tsdb_.*|prometheus_config_.*'
            action: keep

  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.teddysecurity.ai:587'
      smtp_from: 'emergency-alerts@teddysecurity.ai'
      smtp_auth_username: 'emergency-bot'
      smtp_auth_password_file: '/var/run/secrets/email/password'
      smtp_require_tls: true
      resolve_timeout: 30s  # Ø­Ù„ Ø³Ø±ÙŠØ¹ Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
      slack_api_url_file: '/var/run/secrets/slack/webhook-url'
      pagerduty_url: 'https://events.pagerduty.com/v2/enqueue'
      opsgenie_api_url: 'https://api.opsgenie.com/'
      victorops_api_url: 'https://alert.victorops.com/integrations/generic/20131114/alert/'
    
    # Ø´Ø¬Ø±Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
    route:
      receiver: 'emergency-default'
      group_by: ['severity', 'category', 'source', 'instance']
      group_wait: 0s      # Ù„Ø§ Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ø§Ø±Ø¦Ø©
      group_interval: 10s
      repeat_interval: 30s # Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø©
      
      routes:
        # API Key ØªÙ… Ø§Ø®ØªØ±Ø§Ù‚Ù‡Ø§ - Ø¥Ø¬Ø±Ø§Ø¡ ÙÙˆØ±ÙŠ
        - match_re:
            alertname: '(APIKeyCompromised|APIKeyLeaked|UnauthorizedAPIAccess)'
          receiver: 'api-security-emergency'
          group_wait: 0s
          repeat_interval: 15s
          continue: true
        
        # Ù‡Ø¬ÙˆÙ… DDoS - Ø¯ÙØ§Ø¹ ÙÙˆØ±ÙŠ
        - match_re:
            alertname: '(DDoSAttackDetected|MassiveTrafficSpike|SuspiciousTrafficPattern)'
          receiver: 'ddos-defense-team'
          group_wait: 0s
          repeat_interval: 30s
          continue: true
        
        # ØªØ³Ø±ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„ - Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰
        - match_re:
            alertname: '(ChildDataBreach|PersonalDataExfiltration|UnauthorizedDataAccess)'
          receiver: 'child-data-protection'
          group_wait: 0s
          repeat_interval: 10s
          continue: true
        
        # Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù… - Ø¹Ø²Ù„ ÙÙˆØ±ÙŠ
        - match_re:
            alertname: '(SystemCompromised|RootkitDetected|MalwareDetected)'
          receiver: 'system-compromise-team'
          group_wait: 0s
          repeat_interval: 20s
        
        # Ù‡Ø¬Ù…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        - match_re:
            alertname: '(SQLInjectionAttempt|DatabaseIntrusion|SuspiciousQuery)'
          receiver: 'database-security-team'
          group_wait: 5s
          repeat_interval: 60s
    
    receivers:
      # Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø·ÙˆØ§Ø±Ø¦
      - name: 'emergency-default'
        webhook_configs:
          - url: 'https://emergency-response.teddysecurity.ai/webhook/general'
            send_resolved: true
            http_config:
              bearer_token_file: '/var/run/secrets/webhooks/token'
              tls_config:
                insecure_skip_verify: false
            title: 'ðŸš¨ Teddy Security Emergency Alert'
            text: |
              Emergency Alert Details:
              {{ range .Alerts }}
              - Alert: {{ .Labels.alertname }}
              - Severity: {{ .Labels.severity }}
              - Instance: {{ .Labels.instance }}
              - Description: {{ .Annotations.description }}
              {{ end }}
      
      # ÙØ±ÙŠÙ‚ Ø£Ù…Ø§Ù† API Ø§Ù„Ù…Ø®ØªØµ
      - name: 'api-security-emergency'
        pagerduty_configs:
          - routing_key_file: '/var/run/secrets/pagerduty/api-security-key'
            description: 'API Security Breach - Immediate Action Required'
            severity: 'critical'
            component: 'api-gateway'
            group: 'security'
        
        slack_configs:
          - channel: '#api-security-emergency'
            username: 'TeddySecurityBot'
            icon_emoji: ':rotating_light:'
            title: 'ðŸ”¥ API SECURITY BREACH'
            text: |
              CRITICAL: API Security Incident
              {{ range .Alerts }}
              ðŸš¨ {{ .Annotations.summary }}
              ðŸ“ Component: {{ .Labels.component }}
              âš ï¸ Action: {{ .Annotations.remediation }}
              {{ end }}
        
        email_configs:
          - to: 'api-security@teddysecurity.ai'
            subject: 'ðŸš¨ CRITICAL: API Security Breach'
            headers:
              X-Priority: '1'
              X-MC-Important: 'true'
            body: |
              IMMEDIATE ACTION REQUIRED
              
              API Security breach detected and requires immediate intervention:
              {{ range .Alerts }}
              
              Alert: {{ .Labels.alertname }}
              Severity: {{ .Labels.severity }}
              Component: {{ .Labels.component }}
              Instance: {{ .Labels.instance }}
              
              Description: {{ .Annotations.description }}
              Impact: {{ .Annotations.impact }}
              Remediation Steps: {{ .Annotations.remediation }}
              
              Time: {{ .StartsAt }}
              {{ end }}
      
      # ÙØ±ÙŠÙ‚ Ø§Ù„Ø¯ÙØ§Ø¹ Ø¶Ø¯ DDoS
      - name: 'ddos-defense-team'
        opsgenie_configs:
          - api_key_file: '/var/run/secrets/opsgenie/api-key'
            message: 'DDoS Attack Detected - Emergency Response Required'
            description: |
              {{ range .Alerts }}
              DDoS Attack Details:
              - Source: {{ .Labels.source_ip }}
              - Target: {{ .Labels.target }}
              - Magnitude: {{ .Labels.attack_magnitude }}
              {{ end }}
            priority: 'P1'
            tags: ['ddos', 'attack', 'emergency']
        
        webhook_configs:
          - url: 'https://ddos-defense.teddysecurity.ai/webhook/activate'
            send_resolved: true
            http_config:
              bearer_token_file: '/var/run/secrets/ddos/defense-token'
      
      # Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„ - Ø£ÙˆÙ„ÙˆÙŠØ© Ù‚ØµÙˆÙ‰
      - name: 'child-data-protection'
        email_configs:
          - to: 'legal@teddysecurity.ai,compliance@teddysecurity.ai,ceo@teddysecurity.ai'
            subject: 'ðŸš¨ CHILD DATA BREACH - LEGAL ACTION REQUIRED'
            headers:
              X-Priority: '1'
              X-MC-Important: 'true'
              Importance: 'High'
            body: |
              URGENT: CHILD DATA PROTECTION BREACH
              
              A potential breach involving children's personal data has been detected.
              Immediate legal and compliance action is required.
              
              {{ range .Alerts }}
              Breach Details:
              - Type: {{ .Labels.breach_type }}
              - Affected Records: {{ .Labels.affected_records }}
              - Data Categories: {{ .Labels.data_categories }}
              
              Legal Requirements:
              - Report to authorities within 72 hours
              - Notify affected families
              - Document incident for compliance
              - Implement containment measures
              {{ end }}
        
        victorops_configs:
          - api_key_file: '/var/run/secrets/victorops/api-key'
            routing_key: 'child-data-protection'
            message_type: 'CRITICAL'
            entity_display_name: 'Child Data Protection Alert'
            monitoring_tool: 'Teddy Security Monitor'

  security-rules.yml: |
    groups:
      - name: api_security_critical
        interval: 5s
        rules:
          # ØªØ³Ø±ÙŠØ¨ Ù…ÙØ§ØªÙŠØ­ API
          - alert: APIKeyCompromised
            expr: rate(teddy_api_key_invalid_usage[1m]) > 10
            for: 0s
            labels:
              severity: critical
              category: api_security
              component: api-gateway
            annotations:
              summary: "API Key potentially compromised"
              description: "High rate of invalid API key usage detected"
              impact: "Unauthorized access to system APIs"
              remediation: "1. Rotate all API keys immediately 2. Block suspicious IPs 3. Audit access logs"
              dashboard: "https://grafana.teddysecurity.ai/d/api-security"
          
          # ÙˆØµÙˆÙ„ ØºÙŠØ± Ù…ØµØ±Ø­ Ø¨Ù‡ Ù„Ù€ API
          - alert: UnauthorizedAPIAccess
            expr: rate(teddy_api_unauthorized_requests[2m]) > 5
            for: 10s
            labels:
              severity: critical
              category: api_security
              component: api-gateway
            annotations:
              summary: "Unauthorized API access attempts"
              description: "Multiple unauthorized API access attempts detected"
              impact: "Potential system breach"
              remediation: "Block source IPs and review authentication mechanisms"
          
          # Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…ÙØ±Ø· Ù„Ù€ API
          - alert: APIRateLimitBreach
            expr: rate(teddy_api_requests[1m]) > 1000
            for: 30s
            labels:
              severity: warning
              category: api_security
              component: rate-limiter
            annotations:
              summary: "API rate limit exceeded"
              description: "Unusual high API usage detected"
              impact: "Potential DDoS or abuse"
              remediation: "Implement stricter rate limiting"
      
      - name: ddos_protection
        interval: 3s
        rules:
          # Ù‡Ø¬ÙˆÙ… DDoS
          - alert: DDoSAttackDetected
            expr: rate(nginx_http_requests_total[1m]) > 10000
            for: 15s
            labels:
              severity: critical
              category: ddos_attack
              component: nginx-waf
            annotations:
              summary: "DDoS attack in progress"
              description: "Massive traffic spike detected"
              impact: "Service availability at risk"
              remediation: "Activate DDoS protection and block attacking IPs"
          
          # ØªØ±Ø§ÙÙŠÙƒ Ù…Ø´Ø¨ÙˆÙ‡
          - alert: SuspiciousTrafficPattern
            expr: rate(nginx_http_requests_total{status=~"4..|5.."}[2m]) > 100
            for: 20s
            labels:
              severity: warning
              category: ddos_attack
              component: nginx-waf
            annotations:
              summary: "Suspicious traffic pattern detected"
              description: "High error rate indicating potential attack"
      
      - name: data_breach_protection
        interval: 2s
        rules:
          # ØªØ³Ø±ÙŠØ¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø·ÙØ§Ù„
          - alert: ChildDataBreach
            expr: rate(teddy_child_data_unauthorized_access[1m]) > 0
            for: 0s
            labels:
              severity: critical
              category: data_breach
              component: data-protection
              data_type: child_personal_info
            annotations:
              summary: "Unauthorized access to child personal data"
              description: "Critical breach of child data protection"
              impact: "Legal and compliance violations"
              remediation: "1. Isolate affected systems 2. Notify legal team 3. Report to authorities"
          
          # Ù…Ø­Ø§ÙˆÙ„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          - alert: PersonalDataExfiltration
            expr: rate(teddy_data_export_suspicious[5m]) > 0
            for: 10s
            labels:
              severity: critical
              category: data_breach
              component: data-loss-prevention
            annotations:
              summary: "Suspicious data export activity"
              description: "Potential data exfiltration detected"
              impact: "Personal data may be compromised"
              remediation: "Block data exports and investigate source"
      
      - name: system_compromise
        interval: 5s
        rules:
          # Ø§Ø®ØªØ±Ø§Ù‚ Ø§Ù„Ù†Ø¸Ø§Ù…
          - alert: SystemCompromised
            expr: node_security_rootkit_detected > 0
            for: 0s
            labels:
              severity: critical
              category: system_compromise
              component: host-security
            annotations:
              summary: "System compromise detected"
              description: "Rootkit or malware detected on system"
              impact: "Complete system security breach"
              remediation: "Isolate system immediately and initiate incident response"
          
          # Ø¹Ù…Ù„ÙŠØ© Ù…Ø´Ø¨ÙˆÙ‡Ø©
          - alert: SuspiciousProcessActivity
            expr: rate(node_security_suspicious_process[1m]) > 0
            for: 30s
            labels:
              severity: warning
              category: system_compromise
              component: process-monitor
            annotations:
              summary: "Suspicious process activity"
              description: "Unusual process behavior detected"
      
      - name: database_security
        interval: 5s
        rules:
          # Ù…Ø­Ø§ÙˆÙ„Ø© SQL Injection
          - alert: SQLInjectionAttempt
            expr: rate(postgresql_security_injection_attempts[1m]) > 0
            for: 15s
            labels:
              severity: critical
              category: injection_attack
              component: postgresql
            annotations:
              summary: "SQL injection attack detected"
              description: "Malicious SQL injection attempt"
              impact: "Database security breach risk"
              remediation: "Block attacking IPs and review query patterns"
          
          # Ù†Ø´Ø§Ø· Ù…Ø´Ø¨ÙˆÙ‡ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
          - alert: DatabaseIntrusion
            expr: rate(postgresql_security_unauthorized_queries[2m]) > 5
            for: 20s
            labels:
              severity: warning
              category: database_intrusion
              component: postgresql
            annotations:
              summary: "Suspicious database activity"
              description: "Unauthorized or unusual database queries" 