# [AI-Generated by Amazon Q]: ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙÙ‚ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.
from datetime import datetime, timedelta
from typing import Dict, List

import pandas as pd
# [AI-Generated by Amazon Q]: Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø§Øª Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
import plotly.express as px
import plotly.graph_objects as go
from fastapi import FastAPI, HTTPException
from fastapi.responses import HTMLResponse, JSONResponse
from fastapi.staticfiles import StaticFiles

app = FastAPI(title="Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†")

# ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ©
app.mount("/static", StaticFiles(directory="static"), name="static")


class SimpleDashboardService:
    """Ø®Ø¯Ù…Ø© Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„Ù€ API"""

    def __init__(self, db):
        self.db = db
        # [AI-Generated by Amazon Q]: Ø¯Ù…Ø¬ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        from src.domain.analytics import ChildAnalytics

        self.analytics = ChildAnalytics(db)

    def get_interaction_summary(self, child_id: str) -> Dict:
        """Ù…Ù„Ø®Øµ Ø´Ø§Ù…Ù„ Ù„Ù„ØªÙØ§Ø¹Ù„Ø§Øª"""
        # [AI-Generated by Amazon Q]: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        summary = {
            "total_conversations": 25,
            "average_daily_interactions": 3.5,
            "dominant_emotion": self.analytics.get_dominant_emotion(child_id),
            "emotion_stability": self.analytics.calculate_emotion_stability(child_id),
            "favorite_activities": ["Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨", "Ø§Ù„Ù‚ØµØµ"],
            "speech_analysis": {
                "concerns": self.analytics.get_speech_concerns(child_id)
            },
            "learning_progress": self.analytics.get_learning_progress(child_id),
            "social_skills": self.analytics.evaluate_social_skills(child_id),
            "recommendations": self.generate_recommendations(child_id),
        }

        return summary

    def generate_recommendations(self, child_id: str) -> List[str]:
        """ØªÙˆÙ„ÙŠØ¯ ØªÙˆØµÙŠØ§Øª Ù„Ù„Ø£Ù‡Ù„"""
        recommendations = []

        # [AI-Generated by Amazon Q]: ØªÙˆØµÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        emotion_stability = self.analytics.calculate_emotion_stability(child_id)
        speech_concerns = self.analytics.get_speech_concerns(child_id)

        # ØªÙˆØµÙŠØ§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ø¹Ø§Ø·ÙÙŠ
        if emotion_stability < 0.5:
            recommendations.append(
                "Ù„Ø§Ø­Ø¸Ù†Ø§ ØªÙ‚Ù„Ø¨Ø§Øª ÙÙŠ Ù…Ø²Ø§Ø¬ Ø§Ù„Ø·ÙÙ„. ÙŠÙÙ†ØµØ­ Ø¨Ù‚Ø¶Ø§Ø¡ ÙˆÙ‚Øª Ø¥Ø¶Ø§ÙÙŠ Ù…Ø¹Ù‡ ÙˆØ§Ù„ØªØ­Ø¯Ø« Ø¹Ù† Ù…Ø´Ø§Ø¹Ø±Ù‡."
            )

        # ØªÙˆØµÙŠØ§Øª Ø§Ù„Ù†Ø·Ù‚
        if speech_concerns:
            recommendations.append(
                f"ØªÙ… Ø±ØµØ¯ Ø¨Ø¹Ø¶ Ø§Ù„ØªØ­Ø¯ÙŠØ§Øª ÙÙŠ Ø§Ù„Ù†Ø·Ù‚: {', '.join(speech_concerns)}. "
                "Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ù† Ø§Ù„Ù…ÙÙŠØ¯ Ø§Ø³ØªØ´Ø§Ø±Ø© Ø£Ø®ØµØ§Ø¦ÙŠ Ù†Ø·Ù‚."
            )
        else:
            recommendations.append("Ø§Ù„Ø·ÙÙ„ ÙŠØ¸Ù‡Ø± ØªÙØ§Ø¹Ù„Ø§Ù‹ Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ§Ù‹ Ù…Ø¹ Ø§Ù„Ø¯Ù…ÙŠØ©")

        return recommendations

    # [AI-Generated by Amazon Q]: Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    def generate_emotion_chart(self, child_id: str, days: int = 7) -> str:
        """Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø´Ø§Ø¹Ø±"""
        # Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©
        emotion_data = [
            {"date": "2024-01-01", "emotion": "happy", "count": 5},
            {"date": "2024-01-02", "emotion": "happy", "count": 3},
            {"date": "2024-01-02", "emotion": "calm", "count": 2},
            {"date": "2024-01-03", "emotion": "excited", "count": 4},
        ]

        df = pd.DataFrame(emotion_data)

        fig = px.bar(
            df,
            x="date",
            y="count",
            color="emotion",
            title=f"ØªØ·ÙˆØ± Ù…Ø´Ø§Ø¹Ø± Ø§Ù„Ø·ÙÙ„ Ø®Ù„Ø§Ù„ {days} Ø£ÙŠØ§Ù…",
            labels={"date": "Ø§Ù„ØªØ§Ø±ÙŠØ®", "count": "Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª", "emotion": "Ø§Ù„Ù…Ø´Ø§Ø¹Ø±"},
            color_discrete_map={
                "happy": "#4CAF50",
                "calm": "#2196F3",
                "excited": "#FF9800",
            },
        )

        fig.update_layout(height=400, font=dict(family="Arial", size=12))
        return fig.to_html(include_plotlyjs="cdn")

    def generate_progress_chart(self, child_id: str) -> str:
        """Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ"""
        progress_data = self.analytics.get_learning_progress(child_id)

        if progress_data["status"] == "no_data":
            return "<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ©</p>"

        # Ø¨ÙŠØ§Ù†Ø§Øª ÙˆÙ‡Ù…ÙŠØ©
        games = ["Ø§Ù„Ø£Ø³Ø¦Ù„Ø©", "Ø§Ù„Ø£Ù„ØºØ§Ø²", "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª"]
        scores = [85, 78, 92]

        fig = go.Figure(
            data=[
                go.Bar(
                    x=games, y=scores, marker_color=["#4CAF50", "#2196F3", "#FF9800"]
                )
            ]
        )

        fig.update_layout(
            title="ØªÙ‚Ø¯Ù… Ø§Ù„Ø·ÙÙ„ ÙÙŠ Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨",
            xaxis_title="Ù†ÙˆØ¹ Ø§Ù„Ù„Ø¹Ø¨Ø©",
            yaxis_title="Ø§Ù„Ø¯Ø±Ø¬Ø©",
            height=400,
        )

        return fig.to_html(include_plotlyjs="cdn")

    def generate_weekly_report(self, child_id: str) -> str:
        """ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø´Ø§Ù…Ù„"""
        summary = self.get_interaction_summary(child_id)

        # [AI-Generated by Amazon Q]: Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        emotion_chart = self.generate_emotion_chart(child_id, days=7)
        progress_chart = self.generate_progress_chart(child_id)

        html_template = f"""
        <!DOCTYPE html>
        <html dir="rtl" lang="ar">
        <head>
            <meta charset="UTF-8">
            <title>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ - {child_id}</title>
            <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
            <style>
                body {{
                    font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
                    margin: 0;
                    padding: 20px;
                    background-color: #f5f5f5;
                }}
                .container {{
                    max-width: 1200px;
                    margin: auto;
                    background: white;
                    padding: 30px;
                    border-radius: 10px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                }}
                .header {{
                    text-align: center;
                    margin-bottom: 40px;
                    border-bottom: 3px solid #4CAF50;
                    padding-bottom: 20px;
                }}
                .summary-grid {{
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 20px;
                    margin-bottom: 40px;
                }}
                .stat-card {{
                    background: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                    text-align: center;
                    border-left: 4px solid #4CAF50;
                }}
                .stat-value {{
                    font-size: 2em;
                    font-weight: bold;
                    color: #333;
                    margin: 10px 0;
                }}
                .recommendations {{
                    background: #e3f2fd;
                    padding: 20px;
                    border-radius: 8px;
                    margin-top: 40px;
                }}
                .recommendation-item {{
                    margin: 10px 0;
                    padding-right: 20px;
                }}
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h1>
                    <p>Ø§Ù„ÙØªØ±Ø©: {(datetime.now() - timedelta(days=7)).strftime('%Y-%m-%d')} Ø¥Ù„Ù‰ {datetime.now().strftime('%Y-%m-%d')}</p>
                </div>
                
                <div class="summary-grid">
                    <div class="stat-card">
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø§Øª</div>
                        <div class="stat-value">{summary['total_conversations']}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</div>
                        <div class="stat-value">{summary['average_daily_interactions']:.1f}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø³Ø§Ø¦Ø¯</div>
                        <div class="stat-value">{summary['dominant_emotion']}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ø§Ù„Ù…Ø´Ø§Ø¹Ø±</div>
                        <div class="stat-value">{summary['emotion_stability']:.0%}</div>
                    </div>
                </div>
                
                <div class="chart-section">
                    <h2>ØªØ·ÙˆØ± Ø§Ù„Ù…Ø´Ø§Ø¹Ø±</h2>
                    {emotion_chart}
                </div>
                
                <div class="chart-section">
                    <h2>Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ</h2>
                    {progress_chart}
                </div>
                
                <div class="recommendations">
                    <h2>Ø§Ù„ØªÙˆØµÙŠØ§Øª</h2>
                    {''.join([f'<div class="recommendation-item">ğŸ’¡ {rec}</div>' for rec in summary['recommendations']])}
                </div>
            </div>
        </body>
        </html>
        """

        return html_template


# Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§ÙŠØ© API
dashboard_service = None


@app.on_event("startup")
async def startup_event():
    """ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"""
    global dashboard_service
    dashboard_service = SimpleDashboardService(None)


@app.get("/")
async def home():
    """Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"""
    return HTMLResponse(
        """
    <html dir="rtl">
    <head>
        <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ† - AI Teddy Bear</title>
        <style>
            body { 
                font-family: Arial, sans-serif; 
                max-width: 800px; 
                margin: 50px auto;
                padding: 20px;
            }
            .child-list {
                list-style: none;
                padding: 0;
            }
            .child-item {
                background: #f0f0f0;
                margin: 10px 0;
                padding: 15px;
                border-radius: 8px;
            }
            .child-item a {
                text-decoration: none;
                color: #333;
                font-size: 1.2em;
            }
        </style>
    </head>
    <body>
        <h1>Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙˆØ§Ù„Ø¯ÙŠÙ†</h1>
        <div id="children-list">
            <ul class="child-list">
                <li class="child-item"><a href="/dashboard/child1">Ø£Ø­Ù…Ø¯</a></li>
                <li class="child-item"><a href="/dashboard/child2">ÙØ§Ø·Ù…Ø©</a></li>
            </ul>
        </div>
    </body>
    </html>
    """
    )


@app.get("/api/children")
async def get_children():
    """Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø·ÙØ§Ù„"""
    children = [{"id": "child1", "name": "Ø£Ø­Ù…Ø¯"}, {"id": "child2", "name": "ÙØ§Ø·Ù…Ø©"}]
    return JSONResponse(content=children)


@app.get("/dashboard/{child_id}")
async def get_dashboard(child_id: str):
    """Ø¹Ø±Ø¶ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ù„Ø·ÙÙ„ Ù…Ø­Ø¯Ø¯"""
    try:
        report = dashboard_service.generate_weekly_report(child_id)
        return HTMLResponse(content=report)
    except Exception as e:
        raise HTTPException(status_code=404, detail=f"Child not found: {str(e)}")


@app.get("/api/dashboard/{child_id}/summary")
async def get_summary(child_id: str):
    """API Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ù„Ø®Øµ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    try:
        summary = dashboard_service.get_interaction_summary(child_id)
        return JSONResponse(content=summary)
    except Exception as e:
        raise HTTPException(status_code=404, detail=str(e))
