from pathlib import Path
import sys
import subprocess
import os
import structlog
import logging
from typing import Any, Dict, List, Optional

logger = logging.getLogger(__name__)

# [AI-Generated by Amazon Q]: ุชู ุฅุถุงูุฉ ูุฐุง ุงูููุฏ ุชููุงุฆูุงู ููู ุฏููู ุงููุดุฑูุน.
#!/usr/bin/env python3
"""
ุณูุฑูุจุช ุฅุนุฏุงุฏ ูุชุดุบูู ูุดุฑูุน AI Teddy Bear
"""

logger = structlog.get_logger(__name__)


def create_directories() -> Any:
    """ุฅูุดุงุก ุงููุฌูุฏุงุช ุงููุทููุจุฉ"""
    directories = [
        "data",
        "uploads/audio",
        "uploads/temp",
        "outputs/stories",
        "outputs/responses",
        "outputs/processed",
        "static/css",
        "static/js",
        "static/images",
        "logs"
    ]

    for directory in directories:
        Path(directory).mkdir(parents=True, exist_ok=True)
        logger.info(f"โ ุชู ุฅูุดุงุก ูุฌูุฏ: {directory}")


def install_requirements() -> Any:
    """ุชุซุจูุช ุงููุชุทูุจุงุช"""
    logger.info("๐ฆ ุชุซุจูุช ุงููุชุทูุจุงุช...")
    try:
        subprocess.check_call(
            [sys.executable, "-m", "pip", "install", "-r", "requirements.txt"])
        logger.info("โ ุชู ุชุซุจูุช ุฌููุน ุงููุชุทูุจุงุช ุจูุฌุงุญ")
    except Exception as e:
    logger.error(f"Error: {e}")"โ ูุดู ูู ุชุซุจูุช ุงููุชุทูุจุงุช")
        return False
    return True

def create_env_file() -> Any:
    """ุฅูุดุงุก ููู ุงูุจูุฆุฉ"""
    env_content = """# [AI-Generated by Amazon Q]: ููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ

# ููุงุชูุญ API (ูุฌุจ ุชุนุจุฆุชูุง)
OPENAI_API_KEY=your_openai_key_here
HUME_API_KEY=your_hume_key_here
ELEVENLABS_API_KEY=your_elevenlabs_key_here
DEEPGRAM_API_KEY=your_deepgram_key_here

# ูุงุนุฏุฉ ุงูุจูุงูุงุช
DATABASE_URL=sqlite:///data/teddy_bear.db

# ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
SMTP_SERVER=smtp.gmail.com
SMTP_PORT=587
EMAIL_USERNAME=your_email@gmail.com
EMAIL_PASSWORD=your_app_password

# ุฅุนุฏุงุฏุงุช ุงูุฃูุงู
MAX_FILE_SIZE=10485760
RATE_LIMIT_PER_MINUTE=60

# ุฅุนุฏุงุฏุงุช ุงูุชุทุจูู
DEBUG=False
HOST=0.0.0.0
PORT=8000
"""

    if not Path(".env").exists():
        with open(".env", "w", encoding="utf-8") as f:
            f.write(env_content)
        logger.info("โ ุชู ุฅูุดุงุก ููู .env")
        logger.warning("โ๏ธ  ูุฑุฌู ุชุนุจุฆุฉ ููุงุชูุญ API ูู ููู .env")
    else:
        logger.info("โ ููู .env ููุฌูุฏ ุจุงููุนู")

def initialize_database() -> Any:
    """ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช"""
    logger.info("๐๏ธ  ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช...")
    try:
        from src.data.database import Database
        db = Database()
        logger.info("โ ุชู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ")
    except Exception as e:
    logger.error(f"Error: {e}")f"โ ูุดู ูู ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช: {e}")

def run_tests() -> Any:
    """ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช"""
    logger.info("๐งช ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช...")
    try:
        subprocess.check_call([sys.executable, "-m", "pytest", "tests/", "-v"])
        logger.info("โ ุฌููุน ุงูุงุฎุชุจุงุฑุงุช ูุฌุญุช")
    except Exception as e:
    logger.error(f"Error: {e}")"โ๏ธ  ุจุนุถ ุงูุงุฎุชุจุงุฑุงุช ูุดูุช")
    except Exception as e:
    logger.error(f"Error: {e}")"โน๏ธ  ูุง ุชูุฌุฏ ุงุฎุชุจุงุฑุงุช ููุชุดุบูู")

def main() -> Any:
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ ููุฅุนุฏุงุฏ"""
    logger.info("๐ ุจุฏุก ุฅุนุฏุงุฏ ูุดุฑูุน AI Teddy Bear")
    logger.info("=" * 50)

    # ุฅูุดุงุก ุงููุฌูุฏุงุช
    create_directories()

    # ุชุซุจูุช ุงููุชุทูุจุงุช
    if not install_requirements():
        return

    # ุฅูุดุงุก ููู ุงูุจูุฆุฉ
    create_env_file()

    # ุชููุฆุฉ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    initialize_database()

    # ุชุดุบูู ุงูุงุฎุชุจุงุฑุงุช
    run_tests()

    logger.info("\n" + "=" * 50)
    logger.info("โ ุชู ุฅุนุฏุงุฏ ุงููุดุฑูุน ุจูุฌุงุญ!")
    logger.info("\n๐ ุฎุทูุงุช ุงูุชุดุบูู:")
    logger.info("1. ุชุนุจุฆุฉ ููุงุชูุญ API ูู ููู .env")
    logger.info("2. ุชุดุบูู ุงูุฃูุฑ: python main.py")
    logger.info("3. ูุชุญ ุงููุชุตูุญ ุนูู: http://localhost:8000")
    logger.info("\n๐ง ูููุณุงุนุฏุฉ:")
    logger.info("- ููุญุฉ ุงูุฃูู: http://localhost:8000")
    logger.info("- API ุงูุชูุงุนู: http://localhost:8000/interact")
    logger.info("- WebSocket: ws://localhost:8000/ws/{child_id}")

if __name__ == "__main__":
    main()
