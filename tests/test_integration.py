# [AI-Generated by Amazon Q]: ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙÙ‚ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹.
import asyncio
import sys
from pathlib import Path

import pytest

# Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹
sys.path.append(str(Path(__file__).parent.parent))


class TestIntegration:
    """Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙƒØ§Ù…Ù„"""

    @pytest.mark.asyncio
    async def test_voice_interaction_flow(self):
        """Ø§Ø®ØªØ¨Ø§Ø± ØªØ¯ÙÙ‚ Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„ÙƒØ§Ù…Ù„"""
        from config.settings import Config

        from src.application.main_service import AITeddyBearService

        # Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø®Ø¯Ù…Ø©
        config = Config()
        service = AITeddyBearService(config.__dict__)

        # Ø¨Ø¯Ø¡ Ø¬Ù„Ø³Ø©
        session_result = await service.start_session("test_child")
        assert session_result is not None
        assert "message" in session_result

        # Ø¥Ù†Ù‡Ø§Ø¡ Ø¬Ù„Ø³Ø©
        end_result = await service.end_session()
        assert end_result is not None

    def test_database_integration(self):
        """Ø§Ø®ØªØ¨Ø§Ø± ØªÙƒØ§Ù…Ù„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        from src.data.database import Database

        db = Database(":memory:")

        # Ø¥Ù†Ø´Ø§Ø¡ Ø·ÙÙ„
        db.create_child("integration_test", "Ø³Ø§Ø±Ø©", 8, {"language": "ar"})

        # Ø­ÙØ¸ ØªÙØ§Ø¹Ù„
        db.save_interaction("integration_test", "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…", "ÙˆØ¹Ù„ÙŠÙƒÙ… Ø§Ù„Ø³Ù„Ø§Ù…", "happy")

        # Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ù„Ø¹Ø¨Ø©
        db.save_game_result("integration_test", "trivia", 85, 300)

        # Ø­ÙØ¸ ØªØ­Ù„ÙŠÙ„ Ù…Ø´Ø§Ø¹Ø±
        db.save_emotion_analysis("integration_test", "happy", 0.8)

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        child = db.get_child("integration_test")
        assert child["name"] == "Ø³Ø§Ø±Ø©"

        interactions = db.get_interactions("integration_test")
        assert len(interactions) == 1

        games = db.get_game_history("integration_test")
        assert len(games) == 1
        assert games[0]["score"] == 85

    def test_security_integration(self):
        """Ø§Ø®ØªØ¨Ø§Ø± ØªÙƒØ§Ù…Ù„ Ø§Ù„Ø£Ù…Ø§Ù†"""
        from src.infrastructure.security import APISecurityManager, SecurityManager

        security = SecurityManager()
        api_security = APISecurityManager()

        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„ÙØ§Øª
        test_audio = b"RIFF" + b"0" * 1000
        result = security.validate_audio_file("test.wav", test_audio)
        assert result["valid"] == True

        # Ø§Ø®ØªØ¨Ø§Ø± Ø­Ø¯ Ø§Ù„Ù…Ø¹Ø¯Ù„
        assert api_security.check_rate_limit("127.0.0.1") == True

        # Ø§Ø®ØªØ¨Ø§Ø± ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
        dirty_input = "<script>alert('xss')</script>Ù…Ø±Ø­Ø¨Ø§"
        clean_input = api_security.sanitize_input(dirty_input)
        assert "<script>" not in clean_input
        assert "Ù…Ø±Ø­Ø¨Ø§" in clean_input


class TestEndToEnd:
    """Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø´Ø§Ù…Ù„Ø© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ù„Ù„Ù†Ù‡Ø§ÙŠØ©"""

    def test_complete_user_journey(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø­Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒØ§Ù…Ù„Ø©"""
        from src.api.parental_dashboard import ParentalDashboardService
        from src.data.database import Database
        from src.domain.analytics import ChildAnalytics

        # Ø¥Ø¹Ø¯Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        db = Database(":memory:")

        # Ø¥Ù†Ø´Ø§Ø¡ Ø·ÙÙ„
        child_id = "journey_test"
        db.create_child(child_id, "Ù…Ø­Ù…Ø¯", 6, {"interests": ["Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨", "Ø§Ù„Ù‚ØµØµ"]})

        # Ù…Ø­Ø§ÙƒØ§Ø© Ø¹Ø¯Ø© ØªÙØ§Ø¹Ù„Ø§Øª
        interactions = [
            ("Ù…Ø±Ø­Ø¨Ø§", "Ù…Ø±Ø­Ø¨Ø§ Ø¨Ùƒ Ù…Ø­Ù…Ø¯", "happy"),
            ("Ø£Ø±ÙŠØ¯ Ù„Ø¹Ø¨Ø©", "Ù‡ÙŠØ§ Ù†Ù„Ø¹Ø¨ Ù„Ø¹Ø¨Ø© Ù…Ù…ØªØ¹Ø©", "excited"),
            ("Ø§Ø­ÙƒÙŠ Ù„ÙŠ Ù‚ØµØ©", "Ø³Ø£Ø­ÙƒÙŠ Ù„Ùƒ Ù‚ØµØ© Ø¬Ù…ÙŠÙ„Ø©", "calm"),
        ]

        for input_text, response_text, emotion in interactions:
            db.save_interaction(child_id, input_text, response_text, emotion)
            db.save_emotion_analysis(child_id, emotion, 0.8)

        # Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø¯Ù…Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        analytics = ChildAnalytics(db)

        # Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
        dominant_emotion = analytics.get_dominant_emotion(child_id)
        assert dominant_emotion in ["happy", "excited", "calm"]

        stability = analytics.calculate_emotion_stability(child_id)
        assert 0 <= stability <= 1

        # Ø§Ø®ØªØ¨Ø§Ø± Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        dashboard = ParentalDashboardService(db)
        summary = dashboard.get_interaction_summary(child_id)

        assert "total_conversations" in summary
        assert "dominant_emotion" in summary
        assert "recommendations" in summary
        assert len(summary["recommendations"]) > 0

    def test_error_handling(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡"""
        from src.data.database import Database

        db = Database(":memory:")

        # Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù„Ø¨ Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
        child = db.get_child("non_existent")
        assert child is None

        # Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù„Ø¨ ØªÙØ§Ø¹Ù„Ø§Øª Ù„Ø·ÙÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
        interactions = db.get_interactions("non_existent")
        assert interactions == []

    def test_data_consistency(self):
        """Ø§Ø®ØªØ¨Ø§Ø± Ø§ØªØ³Ø§Ù‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
        from src.data.database import Database

        db = Database(":memory:")

        # Ø¥Ù†Ø´Ø§Ø¡ Ø·ÙÙ„
        child_id = "consistency_test"
        db.create_child(child_id, "ÙØ§Ø·Ù…Ø©", 9)

        # Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ¹Ø¯Ø¯Ø©
        for i in range(10):
            db.save_interaction(child_id, f"Ø³Ø¤Ø§Ù„ {i}", f"Ø¬ÙˆØ§Ø¨ {i}", "neutral")
            db.save_emotion_analysis(child_id, "neutral", 0.5)

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§ØªØ³Ø§Ù‚
        interactions = db.get_interactions(child_id)
        emotions = db.get_emotion_history(child_id)

        assert len(interactions) == 10
        assert len(emotions) == 10

        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
        assert interactions[0]["input_text"] == "Ø³Ø¤Ø§Ù„ 9"
        assert interactions[-1]["input_text"] == "Ø³Ø¤Ø§Ù„ 0"


def run_qa_checklist():
    """Ù‚Ø§Ø¦Ù…Ø© ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©"""
    print("ğŸ“‹ ØªØ´ØºÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© ÙØ­Øµ Ø§Ù„Ø¬ÙˆØ¯Ø©...")

    checklist = [
        ("ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", lambda: check_database_init()),
        ("Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©", lambda: check_module_imports()),
        ("Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†", lambda: check_security_settings()),
        ("Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†", lambda: check_config_files()),
        ("Ù…Ø¬Ù„Ø¯Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹", lambda: check_project_structure()),
    ]

    results = []
    for name, check_func in checklist:
        try:
            result = check_func()
            results.append((name, "âœ…" if result else "âŒ"))
            print(f"{'âœ…' if result else 'âŒ'} {name}")
        except Exception as e:
            results.append((name, f"âŒ Ø®Ø·Ø£: {e}"))
            print(f"âŒ {name}: {e}")

    print(f"\nğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬: {sum(1 for _, r in results if r == 'âœ…')}/{len(results)} Ù†Ø¬Ø­")
    return results


def check_database_init():
    """ÙØ­Øµ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª"""
    from src.data.database import Database

    db = Database(":memory:")
    return True


def check_module_imports():
    """ÙØ­Øµ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ÙˆØ­Ø¯Ø§Øª"""
    try:
        from src.application.main_service import AITeddyBearService
        from src.audio.speech_disorder_detector import SpeechDisorderDetector
        from src.domain.services.emotion_analyzer import EmotionAnalyzer

        return True
    except ImportError:
        return False


def check_security_settings():
    """ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†"""
    from src.infrastructure.security import SecurityManager

    security = SecurityManager()
    return len(security.allowed_audio_types) > 0


def check_config_files():
    """ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØªÙƒÙˆÙŠÙ†"""
    required_files = ["requirements.txt", "main.py"]
    return all(Path(f).exists() for f in required_files)


def check_project_structure():
    """ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹"""
    required_dirs = ["src", "config", "uploads", "outputs"]
    return all(Path(d).exists() for d in required_dirs)


if __name__ == "__main__":
    run_qa_checklist()
